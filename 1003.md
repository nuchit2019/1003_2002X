

## üîÅ Method `1003(...)`
‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà **‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡∏ï‡∏≤‡∏° Template ‚Üí ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Excel ‚Üí Zip ‚Üí ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö Client ‚Üí ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß**

#

## ‚úÖ INPUT Parameters:

```java
HttpServletResponse theResponse,
String theTemplateCode,
String theCreateBy,
String thePgSaleCode,
Timestamp theEffectDt,
Timestamp theExpiryDt
```
#
| ‡∏ä‡∏∑‡πà‡∏≠ | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ |
|------|----------|
| `theResponse` | ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô response ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Client (download ‡πÑ‡∏ü‡∏•‡πå) |
| `theTemplateCode` | ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á Template (‡πÄ‡∏ä‡πà‡∏ô ‚Äú1003‚Äù) |
| `theCreateBy` | ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Export |
| `thePgSaleCode` | Package Code |
| `theEffectDt` | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô |
| `theExpiryDt` | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î |

#

## üî¢ STEP 1: Logging ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

```java
logger.info("START export1003Process()");
```

> Log ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô process ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß

#

## üóÇÔ∏è STEP 2: Define Path ‡∏Ç‡∏≠‡∏á SQL ‡πÅ‡∏•‡∏∞ Template

```java
String w_sql_header_grade = ".../header_grade";
String w_sql_header_package2 = ".../header_package2";
...
String w_sql_select_dataDetail = ".../sql_select_data";
String w_root_gen_file = "ex-template-ev/1003/" + theCreateBy;
```

> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î path ‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î SQL ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß

#

## üì¶ STEP 3: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ

```java
List<IBSTempInsGroupDataExpTemplateTO> w_listGroupFile = new ArrayList<>();
...
HashMap<String, Object> w_hashValue = null;
...
File w_fileExcelTemplate = new File(this.resourceFolderOfSQL.getFile(), I_PATH_XLSX_BEGIN_1003EV);
```

> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® List, Map, File ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô process

#

## üß© STEP 4: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Insert ‡∏•‡∏á Temp Table)

```java
this.insertTemplateData(w_template_code, theCreateBy, thePgSaleCode, theEffectDt, theExpiryDt, I_PATH_SQL_ROOT_TEMP_EV);
```

> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á Export ‚Üí Insert ‡∏•‡∏á Temporary Table (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ)

#

## üìÅ STEP 5: ‡∏î‡∏∂‡∏á Group File ‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export

```java
w_listGroupFile = this.selectListGroupFile(...);
```

> ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Group ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á Export ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏° car group/car age ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô

#

## üîÅ STEP 6: ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel

```java
for (IBSTempInsGroupDataExpTemplateTO w_loopGrpFile : w_listGroupFile) {
```

‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏•‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏¢‡πà‡∏≠‡∏¢:

#

### üÜï STEP 6.1: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡∏à‡∏≤‡∏Å Template

```java
w_fileExcelTemplateOut = this.helperFile.createFileWithAutoGenerateFile(w_root_gen_file);
w_fileInput = new FileInputStream(w_fileExcelTemplate);
w_fileOut = new FileOutputStream(w_fileExcelTemplateOut);
w_workBook = new XSSFWorkbook(w_fileInput);
```

> Clone Template Excel ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Workbook

#

### üîß STEP 6.2: ‡∏î‡∏∂‡∏á Group Data ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Group File

```java
w_hashValue = new HashMap<>();
this.addHashMap(w_hashValue, "{carGroup}", w_loopGrpFile.getTmp_value_1());
this.addHashMap(w_hashValue, "{carAge}", w_loopGrpFile.getTmp_value_2());

w_listGroupData = this.selectListGroupData(...);
```

> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢ ‡πÜ ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Sheet

#

### üìÑ STEP 6.3: ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Group ‚Üí Clone Sheet ‚ÄúDATA‚Äù

```java
w_workBook.cloneSheet(w_workBook.getSheetIndex("DATA"), w_sheetNm);
...
w_workBook.removeSheetAt(w_workBook.getSheetIndex("DATA"));
w_workBook.write(w_fileOut);
```

> ‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‚ÄúDATA‚Äù ‡∏ó‡∏µ‡πà clone ‡∏°‡∏≤

#

## ‚úçÔ∏è STEP 7: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Header ‡πÅ‡∏•‡∏∞ Detail ‡∏•‡∏á Excel

### üß† ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dynamic Write

```java
IBSHelperDBForDynamicStyleMsExcelInputTO w_inputDynamicStyleTO = new IBSHelperDBForDynamicStyleMsExcelInputTO();
w_inputDynamicStyleTO.setDataSourceForRead(...);
...
```

> ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° input object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö Dynamic

#

### üîÅ STEP 7.1: ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Group Data ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Sheet

```java
for (IBSTempInsGroupDataExpTemplateTO w_loopTO : w_listGroupData) {
```

‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å method ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° ‡πÜ ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

| ‡∏ä‡∏∑‡πà‡∏≠ Sheet Section | ‡πÉ‡∏ä‡πâ SQL ‡∏à‡∏≤‡∏Å | ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á Excel ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Row |
|--------------------|-------------|-------------------------------|
| Grade              | `header_grade` | row 2 |
| Package 2          | `header_package2` | row 4 |
| Tab Detail 1       | `header_tabDetail1` | row 6 |
| Tab Detail 2       | `header_tabDetail2` | row 7 |
| Tab Detail 3       | `header_tabDetail3` | row 8 |
| Tab Detail 4       | `header_tabDetail4` | row 9 |
| Package 3          | `header_package3` | row 12 |
| Data Detail        | `sql_select_data` | row 13 (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß) |

> ‡∏ó‡∏∏‡∏Å step ‡∏à‡∏∞‡πÉ‡∏ä‡πâ method:
```java
this.setFolderForSqlQueryDynamicHeader(...)
this.setStyleConfigHeader(...)
this.setConfigDynamicHeader(...)
new IBSHelperDBForDynamicStyleMsExcel().excuteDHeader(...)
```

#

## üì¶ STEP 8: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á List ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Zip

```java
w_listFile.add(w_fileExcelOutput);
w_listFileName.add(w_loopGrpFile.getTmp_group_data() + ".xlsx");
```

> ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏á List ‡∏£‡∏≠ Zip

#

## üìö STEP 9: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Zip

```java
this.helperFileZip.generateZipFile(w_listFile, w_listFileName, (theZipFile) -> {
	this.helperFile.copyFile(theZipFile, w_zipFile);
});
```

> Zip ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß copy ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ `w_zipFile`

#

## üì§ STEP 10: ‡∏™‡πà‡∏á Zip ‡∏Å‡∏•‡∏±‡∏ö Client

```java
this.helperHttp.writeFileToClient(..., new FileInputStream(w_zipFile));
```

> ‡πÉ‡∏´‡πâ Client ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå `.zip`

#

## üßπ STEP 11: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß

```java
for (int i = 0; i < w_listFileForClear.size(); i++) {
	this.helperFile.deleteFile(w_listFileForClear.get(i));
}
```

> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå `.xlsx` ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

#

## ‚ùó STEP 12: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Exception

```java
if (w_fileInput != null) w_fileInput.close();
...
IBSHelperException.throwException(e.getMessage());
```

> ‡∏õ‡∏¥‡∏î resource ‡πÅ‡∏•‡∏∞‡πÇ‡∏¢‡∏ô exception ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error
#
### üß© Class
- `ExportService` (‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•)
- `IBSTempInsGroupDataExpTemplateTO` (‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô Group Data)
- `IBSHelperDBForDynamicStyleMsExcel` (‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Excel)
- `HelperFile`, `HelperHttp`, `HelperZipFile` (‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå, HTTP, ZIP)

---

### üß© UML Class Diagram

```mermaid
classDiagram
    class ExportService {
        +export1003Process(response: HttpServletResponse, templateCode: String, createBy: String, pgSaleCode: String, effectDt: Timestamp, expiryDt: Timestamp)
        -insertTemplateData(...)
        -selectListGroupFile(...)
        -selectListGroupData(...)
        -setFolderForSqlQueryDynamicHeader(...)
        -setStyleConfigHeader(...)
        -setConfigDynamicHeader(...)
    }

    class IBSTempInsGroupDataExpTemplateTO {
        +tmp_group_data: String
        +tmp_value_1: String
        +tmp_value_2: String
        +tmp_pg_sale_code: String
    }

    class IBSHelperDBForDynamicStyleMsExcel {
        +excuteDHeader(input: IBSHelperDBForDynamicStyleMsExcelInputTO): File
    }

    class IBSHelperDBForDynamicStyleMsExcelInputTO {
        +setDataSourceForRead(DataSource)
        +setFileExcel(File)
        +setHelperFile(HelperFile)
        +setHelperFileDBEXF(Object)
    }

    class HelperFile {
        +createFileWithAutoGenerateFile(path: String): File
        +copyFile(source: File, target: File)
        +deleteFile(file: File)
    }

    class HelperHttp {
        +writeFileToClient(response, downloadFlag, fileName, mimeType, length, inputStream)
    }

    class HelperZipFile {
        +generateZipFile(fileList: List<File>, fileNames: List<String>, callback: Function)
    }

    ExportService --> IBSTempInsGroupDataExpTemplateTO : uses
    ExportService --> IBSHelperDBForDynamicStyleMsExcel : writes
    ExportService --> IBSHelperDBForDynamicStyleMsExcelInputTO : configures
    ExportService --> HelperFile : file ops
    ExportService --> HelperHttp : send response
    ExportService --> HelperZipFile : zip files
```
#

### üß† Diagram ‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∞‡πÑ‡∏£?

| ‡∏Ñ‡∏•‡∏≤‡∏™ | ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó |
|------|--------|
| `ExportService` | Logic ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export ‡πÑ‡∏ü‡∏•‡πå |
| `IBSTempInsGroupDataExpTemplateTO` | ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Group ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet |
| `IBSHelperDBForDynamicStyleMsExcel` | ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Excel ‡∏à‡∏≤‡∏Å SQL |
| `HelperFile` | ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß |
| `HelperHttp` | ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö Client |
| `HelperZipFile` | ZIP ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô 1 ZIP |
#
## üìå Sequence Diagram:
```mermaid
sequenceDiagram
    participant Client
    participant Controller
    participant ExportService
    participant DB
    participant FileSystem
    participant ExcelHelper
    participant ZipHelper
    participant HttpResponse

    %% STEP 1: Logging ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    Note over ExportService: STEP 1 - Start export1003Process()
    Client->>Controller: Request export1003Process()
    Controller->>ExportService: export1003Process(...)

    %% STEP 2: Define SQL Path ‡πÅ‡∏•‡∏∞ Temp Folder
    Note over ExportService: STEP 2 - Define SQL paths, folder
    ExportService->>ExportService: Define SQL paths, temp folder

    %% STEP 3: Init Variables
    Note over ExportService: STEP 3 - Init variables, list, map
    ExportService->>ExportService: Init lists, maps, files

    %% STEP 4: Insert Temp Data
    Note over DB,ExportService: STEP 4 - Insert Temp Data
    ExportService->>DB: insertTemplateData(...)
    DB-->>ExportService: OK

    %% STEP 5: ‡∏î‡∏∂‡∏á Group File
    Note over DB,ExportService: STEP 5 - Select Group File
    ExportService->>DB: selectListGroupFile(...)
    DB-->>ExportService: List<GroupFile>

    alt GroupFile not empty
        loop each GroupFile
            %% STEP 6.1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡∏à‡∏≤‡∏Å Template
            Note over FileSystem,ExcelHelper: STEP 6.1 - Create Excel file
            ExportService->>FileSystem: createFileWithAutoGenerateFile()
            ExportService->>FileSystem: read Excel template
            ExportService->>ExcelHelper: clone workbook from template

            %% STEP 6.2: ‡∏î‡∏∂‡∏á Group Data
            Note over DB,ExportService: STEP 6.2 - Select Group Data
            ExportService->>DB: selectListGroupData(carGroup, carAge)
            DB-->>ExportService: List<GroupData>

            alt GroupData not empty
                %% STEP 6.3: ‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet ‡∏ï‡∏≤‡∏° Group Data
                Note over ExcelHelper: STEP 6.3 - Clone Sheet per GroupData
                loop each GroupData
                    ExcelHelper->>ExcelHelper: cloneSheet("DATA", sheetName)
                end
                ExcelHelper->>ExcelHelper: removeSheet("DATA")
                ExcelHelper->>FileSystem: write workbook

                %% STEP 7: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header & Detail
                Note over ExcelHelper,DB: STEP 7 - Write headers & detail
                loop each GroupData
                    ExportService->>ExcelHelper: set SQL header config (grade)
                    ExcelHelper->>DB: query header data
                    DB-->>ExcelHelper: header data
                    ExcelHelper->>FileSystem: write to sheet

                    ExportService->>ExcelHelper: set SQL header config (package2)
                    ExcelHelper->>DB: query header
                    ExcelHelper->>FileSystem: write

                    ExportService->>ExcelHelper: set SQL header config (tabDetail1-4)
                    ExcelHelper->>DB: query headers
                    ExcelHelper->>FileSystem: write each tab

                    ExportService->>ExcelHelper: set SQL header config (package3)
                    ExcelHelper->>DB: query
                    ExcelHelper->>FileSystem: write

                    ExportService->>ExcelHelper: set SQL detail config
                    ExcelHelper->>DB: query detail rows
                    ExcelHelper->>FileSystem: write detail data
                end

                %% STEP 8: ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á list
                Note over ExportService: STEP 8 - Add file to listFile
                ExportService->>ExportService: add Excel to listFile + listFileName

            else GroupData is empty
                ExportService-->>Controller: throwException("GroupData is null")
            end
        end
    else No Group File
        ExportService-->>Controller: throwException("No group file found")
    end

    %% STEP 9: Zip ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    Note over ZipHelper: STEP 9 - Generate zip file
    ExportService->>ZipHelper: generateZipFile(listFile, listFileName)
    ZipHelper->>FileSystem: create zip
    FileSystem-->>ZipHelper: zip file
    ZipHelper-->>ExportService: return zip file

    %% STEP 10: ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö Client
    Note over HttpResponse: STEP 10 - Send zip to client
    alt zipFile not empty
        ExportService->>HttpResponse: writeFileToClient(...)
    else
        ExportService-->>Controller: throwException("Zip file is empty")
    end

    %% STEP 11: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    Note over FileSystem: STEP 11 - Delete temp files
    loop each file in listFileForClear
        ExportService->>FileSystem: deleteFile(file)
    end

    %% STEP 12: ‡∏à‡∏ö Process
    Note over Controller: STEP 12 - Done
    ExportService-->>Controller: Done
    Controller-->>Client: Return .zip file
```

##
## ‚úÖ Flowchart Diagram:
```mermaid 
flowchart TD
    A1[STEP 1: Logging ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô] --> A2[STEP 2: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î SQL Path ‡πÅ‡∏•‡∏∞ Temp Folder]
    A2 --> A3[STEP 3: Init Variables]
    A3 --> A4[STEP 4: Insert Temp Data]
    A4 --> A5[STEP 5: Select Group File]
    A5 --> A6{STEP 6: ‡∏°‡∏µ Group File ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà}

    A6 -- No --> AE1[Throw Exception: No Group File] --> AE[END]
    A6 -- Yes --> B1[STEP 6.1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡∏à‡∏≤‡∏Å Template]
    B1 --> B2[STEP 6.2: ‡∏î‡∏∂‡∏á Group Data]
    B2 --> B3{Group Data ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà}
    
    B3 -- No --> AE2[Throw Exception: GroupData is null] --> AE
    B3 -- Yes --> B4[STEP 6.3: Clone Sheet ‡∏à‡∏≤‡∏Å Template]
    B4 --> C1[STEP 7: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header ‡πÅ‡∏•‡∏∞ Detail ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∏‡∏î]
    C1 --> D1[STEP 8: ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á List]

    D1 --> A6

    D1 --> E1[STEP 9: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ZIP]
    E1 --> E2{ZIP file ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà}
    E2 -- No --> AE3[Throw Exception: ZIP is empty] --> AE
    E2 -- Yes --> E3[STEP 10: ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö Client]
    E3 --> E4[STEP 11: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß]
    E4 --> AE[STEP 12: END]

```
  

##

## üìå ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô

| ‡∏Ç‡∏±‡πâ‡∏ô | ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î |
|------|------------|
| 1Ô∏è‚É£ | Logging ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô |
| 2Ô∏è‚É£ | ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Path SQL ‡πÅ‡∏•‡∏∞ Temp Folder |
| 3Ô∏è‚É£ | ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ |
| 4Ô∏è‚É£ | Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Temp |
| 5Ô∏è‚É£ | ‡∏î‡∏∂‡∏á Group ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á Export |
| 6Ô∏è‚É£ | ‡∏ß‡∏ô‡∏•‡∏π‡∏õ Group File ‚Üí Clone Excel ‡∏à‡∏≤‡∏Å Template |
| 7Ô∏è‚É£ | ‡∏ß‡∏ô‡∏•‡∏π‡∏õ Group Data ‚Üí ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header & Detail |
| 8Ô∏è‚É£ | ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á List |
| 9Ô∏è‚É£ | Zip ‡πÑ‡∏ü‡∏•‡πå |
| üîü | ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ Client |
| üîÅ | ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß |
| ‚ö†Ô∏è | ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Exception |
#
