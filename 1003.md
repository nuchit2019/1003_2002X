‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô `1003(...)` ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ò‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà **Export Excel Template ‡πÅ‡∏ö‡∏ö Dynamic** ‡∏ï‡∏≤‡∏° Group ‡πÅ‡∏•‡∏∞ Data ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Header ‡πÅ‡∏•‡∏∞ Detail ‡∏à‡∏≤‡∏Å SQL File ‡πÅ‡∏•‡πâ‡∏ß **ZIP ‡πÑ‡∏ü‡∏•‡πå** ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ Client ‡∏ú‡πà‡∏≤‡∏ô `HttpServletResponse`

#

### üìå Parameters:
```java
HttpServletResponse theResponse       // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Client
String theTemplateCode               // Template ‡∏£‡∏´‡∏±‡∏™ (1003)
String theCreateBy                   // ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå
String thePgSaleCode                 // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
Timestamp theEffectDt               // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
Timestamp theExpiryDt               // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
```

#

## üîç ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î

#

### 1. üîß ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Path SQL & Template
```java
String w_sql_header_grade = ".../sql_header_data/header_grade";
...
String w_sql_select_dataDetail = ".../sql_select_data";
String w_root_gen_file = "ex-template-ev/1003/" + theCreateBy;
```
- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏≤‡∏ò‡πÑ‡∏ü‡∏•‡πå SQL ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Header ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
- `w_root_gen_file` ‡∏Ñ‡∏∑‡∏≠ root folder ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)

#

### 2. üß∫ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
```java
List<IBSTempInsGroupDataExpTemplateTO> w_listGroupFile = new ArrayList<>();
List<File> w_listFile = new ArrayList<>();
...
HashMap<String, Object> w_hashValue = null;
```
- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° List ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Group Data (‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå), ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡πÅ‡∏•‡∏∞ Map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡πÉ‡∏ô SQL (‡πÄ‡∏ä‡πà‡∏ô `{carGroup}`)

#

### 3. üìÅ ‡πÇ‡∏´‡∏•‡∏î Template ‡πÑ‡∏ü‡∏•‡πå .xlsx
```java
File w_fileExcelTemplate = new File(..., I_PATH_XLSX_BEGIN_1003EV);
```
- ‡πÇ‡∏´‡∏•‡∏î Template Excel (‡∏ó‡∏µ‡πà‡∏°‡∏µ Sheet "DATA" ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ)

#

### 4. üß© Insert Data ‡∏•‡∏á Temp Table
```java
this.insertTemplateData(...);
```
- ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Oracle ‡∏´‡∏£‡∏∑‡∏≠ Data Source ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÑ‡∏õ Insert ‡∏•‡∏á Table Temp ‡∏ï‡∏≤‡∏° Template 1003

#

### 5. üßµ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå (Group File)
```java
w_listGroupFile = this.selectListGroupFile(...);
```
- ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á Excel ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Group ‡πÄ‡∏ä‡πà‡∏ô Car Group, Car Age ‡∏Ø‡∏•‡∏Ø

#

### 6. üîÅ Loop Group File (‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Group)
```java
for (IBSTempInsGroupDataExpTemplateTO w_loopGrpFile : w_listGroupFile) {
```
- ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏≠‡∏≤‡∏¢‡∏∏ 1-3 ‡∏õ‡∏µ, 4-7 ‡∏õ‡∏µ ‡∏Ø‡∏•‡∏Ø

#

### 7. üß´ Clone Sheet ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠
```java
w_workBook.cloneSheet(..., w_sheetNm);
w_workBook.removeSheetAt(... "DATA");
```
- Clone Sheet "DATA" ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°
- ‡∏•‡∏ö Sheet "DATA" ‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß

#

### 8. üìÑ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header ‡πÅ‡∏•‡∏∞ Detail ‡∏•‡∏á Sheet
```java
this.setFolderForSqlQueryDynamicHeader(...);
this.setConfigDynamicHeader(...);
new IBSHelperDBForDynamicStyleMsExcel().excuteDHeader(...);
```
- ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£
  - ‡∏≠‡πà‡∏≤‡∏ô SQL Template (‡∏û‡∏£‡πâ‡∏≠‡∏° `HashMap` ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£)
  - ‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Style ‡πÅ‡∏•‡∏∞ Cell
  - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÉ‡∏ô Sheet ‡∏ó‡∏µ‡πà clone

‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ï‡∏≤‡∏° Header ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏ä‡πà‡∏ô:
- DT_DP_HEAD1 = Grade
- DT_DP_HEAD2 = Package
- DT_DP_HEAD3 = Summary
- Tab Detail 1-4 = ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏Ø‡∏•‡∏Ø
- Select Data Detail = ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

#

### 9. üì¶ ‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
```java
w_listFile.add(w_fileExcelOutput);
w_listFileName.add(w_loopGrpFile.getTmp_group_data() + ".xlsx");
```
- ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Zip

#

### 10. üóúÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á ZIP ‡πÑ‡∏ü‡∏•‡πå
```java
this.helperFileZip.generateZipFile(w_listFile, w_listFileName, (theZipFile) -> {
    this.helperFile.copyFile(theZipFile, w_zipFile);
});
```
- ‡∏™‡∏£‡πâ‡∏≤‡∏á ZIP ‡πÅ‡∏•‡∏∞‡∏Å‡πá‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô `w_zipFile`

#

### 11. üì§ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ Client
```java
this.helperHttp.writeFileToClient(..., w_zipFile.length(), new FileInputStream(w_zipFile));
```
- ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå `.zip` ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Client ‡∏ú‡πà‡∏≤‡∏ô `HttpServletResponse`

#

### 12. üßπ ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Temp
```java
for (...) {
    this.helperFile.deleteFile(w_listFileForClear.get(i));
}
```
- ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏Å Disk)

#

### 13. ‚ùå Catch Exception
```java
catch (Exception e) {
    w_fileInput.close(); ...
    IBSHelperException.throwException(e.getMessage());
}
```
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î Resource ‡πÅ‡∏•‡∏∞‡πÇ‡∏¢‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô

#


 
```mermaid
sequenceDiagram
participant Client
participant Export1003Process
participant Database
participant ExcelTemplate
participant ZipUtility
participant TempFileSystem

Client->>Export1003Process: Request export1003Process()
activate Export1003Process

Note right of Export1003Process: Step 1: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Path SQL & Template Excel
Export1003Process->>TempFileSystem: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Path SQL ‡πÅ‡∏•‡∏∞ Template Files

Note right of Export1003Process: Step 2: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Process
Export1003Process->>Export1003Process: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

Note right of Export1003Process: Step 3: Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Temporary Table
Export1003Process->>Database: Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Export
Database-->>Export1003Process: Insert Success

Note right of Export1003Process: Step 4: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
Export1003Process->>Database: Select ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Excel
Database-->>Export1003Process: ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤

alt ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå
    loop Step 5: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå
        Export1003Process->>ExcelTemplate: Clone Template Excel
        ExcelTemplate-->>Export1003Process: ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå Excel Template ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
        Export1003Process->>Database: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Detail ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Sheet
        Database-->>Export1003Process: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Detail ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
        Export1003Process->>ExcelTemplate: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Sheet
        ExcelTemplate-->>Export1003Process: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
        Export1003Process->>TempFileSystem: ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    end

    Note right of Export1003Process: Step 6: ‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô Zip
    Export1003Process->>ZipUtility: Zip ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
    ZipUtility-->>Export1003Process: ‡πÑ‡∏î‡πâ Zip File

    Note right of Export1003Process: Step 7: ‡∏™‡πà‡∏á Zip File ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Client
    Export1003Process->>Client: ‡∏™‡πà‡∏á Zip File ‡∏ú‡πà‡∏≤‡∏ô HttpServletResponse
else ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå
    Export1003Process->>Client: ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå
end
```

#
## ‚úÖ Flowchart Diagram
```mermaid
```mermaid
sequenceDiagram
    participant Client
    participant Controller
    participant ExportService
    participant DB
    participant FileSystem
    participant ExcelHelper
    participant ZipHelper
    participant HttpResponse

    %% STEP 1: Logging ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    Note over ExportService: STEP 1 - Start export1003Process()
    Client->>Controller: Request export1003Process()
    Controller->>ExportService: export1003Process(...)

    %% STEP 2: Define SQL Path ‡πÅ‡∏•‡∏∞ Temp Folder
    Note over ExportService: STEP 2 - Define SQL paths, folder
    ExportService->>ExportService: Define SQL paths, temp folder

    %% STEP 3: Init Variables
    Note over ExportService: STEP 3 - Init variables, list, map
    ExportService->>ExportService: Init lists, maps, files

    %% STEP 4: Insert Temp Data
    Note over DB,ExportService: STEP 4 - Insert Temp Data
    ExportService->>DB: insertTemplateData(...)
    DB-->>ExportService: OK

    %% STEP 5: ‡∏î‡∏∂‡∏á Group File
    Note over DB,ExportService: STEP 5 - Select Group File
    ExportService->>DB: selectListGroupFile(...)
    DB-->>ExportService: List<GroupFile>

    alt GroupFile not empty
        loop each GroupFile
            %% STEP 6.1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡∏à‡∏≤‡∏Å Template
            Note over FileSystem,ExcelHelper: STEP 6.1 - Create Excel file
            ExportService->>FileSystem: createFileWithAutoGenerateFile()
            ExportService->>FileSystem: read Excel template
            ExportService->>ExcelHelper: clone workbook from template

            %% STEP 6.2: ‡∏î‡∏∂‡∏á Group Data
            Note over DB,ExportService: STEP 6.2 - Select Group Data
            ExportService->>DB: selectListGroupData(carGroup, carAge)
            DB-->>ExportService: List<GroupData>

            alt GroupData not empty
                %% STEP 6.3: ‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet ‡∏ï‡∏≤‡∏° Group Data
                Note over ExcelHelper: STEP 6.3 - Clone Sheet per GroupData
                loop each GroupData
                    ExcelHelper->>ExcelHelper: cloneSheet("DATA", sheetName)
                end
                ExcelHelper->>ExcelHelper: removeSheet("DATA")
                ExcelHelper->>FileSystem: write workbook

                %% STEP 7: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header & Detail
                Note over ExcelHelper,DB: STEP 7 - Write headers & detail
                loop each GroupData
                    ExportService->>ExcelHelper: set SQL header config (grade)
                    ExcelHelper->>DB: query header data
                    DB-->>ExcelHelper: header data
                    ExcelHelper->>FileSystem: write to sheet

                    ExportService->>ExcelHelper: set SQL header config (package2)
                    ExcelHelper->>DB: query header
                    ExcelHelper->>FileSystem: write

                    ExportService->>ExcelHelper: set SQL header config (tabDetail1-4)
                    ExcelHelper->>DB: query headers
                    ExcelHelper->>FileSystem: write each tab

                    ExportService->>ExcelHelper: set SQL header config (package3)
                    ExcelHelper->>DB: query
                    ExcelHelper->>FileSystem: write

                    ExportService->>ExcelHelper: set SQL detail config
                    ExcelHelper->>DB: query detail rows
                    ExcelHelper->>FileSystem: write detail data
                end

                %% STEP 8: ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á list
                Note over ExportService: STEP 8 - Add file to listFile
                ExportService->>ExportService: add Excel to listFile + listFileName

            else GroupData is empty
                ExportService-->>Controller: throwException("GroupData is null")
            end
        end
    else No Group File
        ExportService-->>Controller: throwException("No group file found")
    end

    %% STEP 9: Zip ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    Note over ZipHelper: STEP 9 - Generate zip file
    ExportService->>ZipHelper: generateZipFile(listFile, listFileName)
    ZipHelper->>FileSystem: create zip
    FileSystem-->>ZipHelper: zip file
    ZipHelper-->>ExportService: return zip file

    %% STEP 10: ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö Client
    Note over HttpResponse: STEP 10 - Send zip to client
    alt zipFile not empty
        ExportService->>HttpResponse: writeFileToClient(...)
    else
        ExportService-->>Controller: throwException("Zip file is empty")
    end

    %% STEP 11: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    Note over FileSystem: STEP 11 - Delete temp files
    loop each file in listFileForClear
        ExportService->>FileSystem: deleteFile(file)
    end

    %% STEP 12: ‡∏à‡∏ö Process
    Note over Controller: STEP 12 - Done
    ExportService-->>Controller: Done
    Controller-->>Client: Return .zip file


```

#

## ‚úÖ ‡∏™‡∏£‡∏∏‡∏õ Flow:

1. Insert Data ‚Üí Select Group
2. Loop Group:
   - Clone Sheet
   - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header + Detail ‡∏à‡∏≤‡∏Å SQL
   - ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡∏ï‡πà‡∏≠ Group
3. ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ ZIP
4. ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö Client
5. ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
