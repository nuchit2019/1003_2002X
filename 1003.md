‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô `1003(...)` ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ò‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà **Export Excel Template ‡πÅ‡∏ö‡∏ö Dynamic** ‡∏ï‡∏≤‡∏° Group ‡πÅ‡∏•‡∏∞ Data ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Header ‡πÅ‡∏•‡∏∞ Detail ‡∏à‡∏≤‡∏Å SQL File ‡πÅ‡∏•‡πâ‡∏ß **ZIP ‡πÑ‡∏ü‡∏•‡πå** ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ Client ‡∏ú‡πà‡∏≤‡∏ô `HttpServletResponse`

#

### üìå Parameters:
```java
HttpServletResponse theResponse       // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Client
String theTemplateCode               // Template ‡∏£‡∏´‡∏±‡∏™ (1003)
String theCreateBy                   // ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå
String thePgSaleCode                 // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
Timestamp theEffectDt               // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
Timestamp theExpiryDt               // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
```

#

## üîç ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î

#

### 1. üîß ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Path SQL & Template
```java
String w_sql_header_grade = ".../sql_header_data/header_grade";
...
String w_sql_select_dataDetail = ".../sql_select_data";
String w_root_gen_file = "ex-template-ev/1003/" + theCreateBy;
```
- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏≤‡∏ò‡πÑ‡∏ü‡∏•‡πå SQL ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Header ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
- `w_root_gen_file` ‡∏Ñ‡∏∑‡∏≠ root folder ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)

#

### 2. üß∫ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
```java
List<IBSTempInsGroupDataExpTemplateTO> w_listGroupFile = new ArrayList<>();
List<File> w_listFile = new ArrayList<>();
...
HashMap<String, Object> w_hashValue = null;
```
- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° List ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Group Data (‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå), ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡πÅ‡∏•‡∏∞ Map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡πÉ‡∏ô SQL (‡πÄ‡∏ä‡πà‡∏ô `{carGroup}`)

#

### 3. üìÅ ‡πÇ‡∏´‡∏•‡∏î Template ‡πÑ‡∏ü‡∏•‡πå .xlsx
```java
File w_fileExcelTemplate = new File(..., I_PATH_XLSX_BEGIN_1003EV);
```
- ‡πÇ‡∏´‡∏•‡∏î Template Excel (‡∏ó‡∏µ‡πà‡∏°‡∏µ Sheet "DATA" ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ)

#

### 4. üß© Insert Data ‡∏•‡∏á Temp Table
```java
this.insertTemplateData(...);
```
- ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Oracle ‡∏´‡∏£‡∏∑‡∏≠ Data Source ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÑ‡∏õ Insert ‡∏•‡∏á Table Temp ‡∏ï‡∏≤‡∏° Template 1003

#

### 5. üßµ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå (Group File)
```java
w_listGroupFile = this.selectListGroupFile(...);
```
- ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á Excel ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Group ‡πÄ‡∏ä‡πà‡∏ô Car Group, Car Age ‡∏Ø‡∏•‡∏Ø

#

### 6. üîÅ Loop Group File (‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Group)
```java
for (IBSTempInsGroupDataExpTemplateTO w_loopGrpFile : w_listGroupFile) {
```
- ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏≠‡∏≤‡∏¢‡∏∏ 1-3 ‡∏õ‡∏µ, 4-7 ‡∏õ‡∏µ ‡∏Ø‡∏•‡∏Ø

#

### 7. üß´ Clone Sheet ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠
```java
w_workBook.cloneSheet(..., w_sheetNm);
w_workBook.removeSheetAt(... "DATA");
```
- Clone Sheet "DATA" ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°
- ‡∏•‡∏ö Sheet "DATA" ‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß

#

### 8. üìÑ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header ‡πÅ‡∏•‡∏∞ Detail ‡∏•‡∏á Sheet
```java
this.setFolderForSqlQueryDynamicHeader(...);
this.setConfigDynamicHeader(...);
new IBSHelperDBForDynamicStyleMsExcel().excuteDHeader(...);
```
- ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£
  - ‡∏≠‡πà‡∏≤‡∏ô SQL Template (‡∏û‡∏£‡πâ‡∏≠‡∏° `HashMap` ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£)
  - ‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Style ‡πÅ‡∏•‡∏∞ Cell
  - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÉ‡∏ô Sheet ‡∏ó‡∏µ‡πà clone

‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ï‡∏≤‡∏° Header ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏ä‡πà‡∏ô:
- DT_DP_HEAD1 = Grade
- DT_DP_HEAD2 = Package
- DT_DP_HEAD3 = Summary
- Tab Detail 1-4 = ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏Ø‡∏•‡∏Ø
- Select Data Detail = ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

#

### 9. üì¶ ‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
```java
w_listFile.add(w_fileExcelOutput);
w_listFileName.add(w_loopGrpFile.getTmp_group_data() + ".xlsx");
```
- ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Zip

#

### 10. üóúÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á ZIP ‡πÑ‡∏ü‡∏•‡πå
```java
this.helperFileZip.generateZipFile(w_listFile, w_listFileName, (theZipFile) -> {
    this.helperFile.copyFile(theZipFile, w_zipFile);
});
```
- ‡∏™‡∏£‡πâ‡∏≤‡∏á ZIP ‡πÅ‡∏•‡∏∞‡∏Å‡πá‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô `w_zipFile`

#

### 11. üì§ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ Client
```java
this.helperHttp.writeFileToClient(..., w_zipFile.length(), new FileInputStream(w_zipFile));
```
- ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå `.zip` ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Client ‡∏ú‡πà‡∏≤‡∏ô `HttpServletResponse`

#

### 12. üßπ ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Temp
```java
for (...) {
    this.helperFile.deleteFile(w_listFileForClear.get(i));
}
```
- ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏Å Disk)

#

### 13. ‚ùå Catch Exception
```java
catch (Exception e) {
    w_fileInput.close(); ...
    IBSHelperException.throwException(e.getMessage());
}
```
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î Resource ‡πÅ‡∏•‡∏∞‡πÇ‡∏¢‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô

#


 
## ‚úÖ **Sequence Diagram
```mermaid
sequenceDiagram
    participant Client
    participant Controller
    participant ExportService
    participant DB
    participant FileHelper
    participant ExcelHelper
    participant ZipHelper

    Client->>Controller: Call export1003EvProcess()
    Controller->>ExportService: export1003EvProcess()
    ExportService->>DB: Insert Template Data
    ExportService->>DB: Select Group File
    loop For each GroupFile
        ExportService->>FileHelper: Create Excel Template File
        ExportService->>DB: Select Group Data
        loop For each GroupData
            ExportService->>ExcelHelper: Clone Sheet
            ExportService->>ExcelHelper: Write Header: Grade
            ExportService->>ExcelHelper: Write Header: Package2
            ExportService->>ExcelHelper: Write Tab Detail 1~4
            ExportService->>ExcelHelper: Write Header: Package3
            ExportService->>ExcelHelper: Write Data Detail
        end
        ExportService->>FileHelper: Add file to list
    end
    ExportService->>ZipHelper: Generate Zip File
    ZipHelper->>FileHelper: Copy Zip to temp
    ExportService->>Client: Return Zip File
    ExportService->>FileHelper: Delete Temp Files
```
#
## ‚úÖ Flowchart Diagram
```mermaid
flowchart TD
    Start["Start export1003EvProcess"]
    InsertData["Insert Template Data"]
    SelectGroupFile["Select Group File"]
    CheckGroup{"GroupFile not empty?"}
    LoopGroupFile["Loop: GroupFile"]
    CreateExcel["Create Excel File"]
    CloneSheet["Clone Template Sheet"]
    SelectGroupData["Select Group Data"]
    CheckGroupData{"GroupData not empty?"}
    LoopGroupData["Loop: GroupData"]
    WriteHeader1["Write Header: Grade"]
    WriteHeader2["Write Header: Package2"]
    WriteTab1["Write Tab Detail 1"]
    WriteTab2["Write Tab Detail 2"]
    WriteTab3["Write Tab Detail 3"]
    WriteTab4["Write Tab Detail 4"]
    WritePackage3["Write Header: Package3"]
    WriteDetail["Write Data Detail"]
    AddToZip["Add File to Zip List"]
    CheckNextGroup{"More GroupFile?"}
    GenerateZip["Generate Zip File"]
    ReturnFile["Return Zip File to Client"]
    DeleteTemp["Delete Temp Files"]
    End["End Process"]

    %% Flow ‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å
    Start --> InsertData
    InsertData --> SelectGroupFile
    SelectGroupFile --> CheckGroup
    CheckGroup -- Yes --> LoopGroupFile
    CheckGroup -- No --> End

    LoopGroupFile --> CreateExcel
    CreateExcel --> CloneSheet
    CloneSheet --> SelectGroupData
    SelectGroupData --> CheckGroupData
    CheckGroupData -- Yes --> LoopGroupData
    CheckGroupData -- No --> End

    LoopGroupData --> WriteHeader1
    WriteHeader1 --> WriteHeader2
    WriteHeader2 --> WriteTab1
    WriteTab1 --> WriteTab2
    WriteTab2 --> WriteTab3
    WriteTab3 --> WriteTab4
    WriteTab4 --> WritePackage3
    WritePackage3 --> WriteDetail
    WriteDetail --> AddToZip

    AddToZip --> CheckNextGroup
    CheckNextGroup -- Yes --> LoopGroupFile
    CheckNextGroup -- No --> GenerateZip

    GenerateZip --> ReturnFile --> DeleteTemp --> End

```
#

## ‚úÖ ‡∏™‡∏£‡∏∏‡∏õ Flow:

1. Insert Data ‚Üí Select Group
2. Loop Group:
   - Clone Sheet
   - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Header + Detail ‡∏à‡∏≤‡∏Å SQL
   - ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡∏ï‡πà‡∏≠ Group
3. ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ ZIP
4. ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö Client
5. ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
